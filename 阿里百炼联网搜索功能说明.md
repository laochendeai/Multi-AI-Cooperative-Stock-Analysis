# 🌐 阿里百炼联网搜索功能集成说明

## 📋 功能概述

TradingAgents系统已成功集成阿里百炼DashScope的联网搜索功能，为情感分析师、新闻分析师和基本面分析师提供实时互联网数据获取能力。

## 🔧 技术实现

### 核心API调用方法
```python
async def _call_dashscope(self, api_key: str, model: str, prompt: str, agent_id: str) -> str:
    """调用阿里百炼DashScope API（支持联网搜索）"""
    
    # 检查是否需要联网搜索
    need_internet = agent_id in ["social_media_analyst", "news_analyst", "fundamentals_analyst"]
    
    # 配置搜索参数
    if need_internet:
        call_params.update({
            'enable_search': True,
            'search_options': {
                "forced_search": True,           # 强制开启联网搜索
                "enable_source": True,           # 返回搜索来源信息
                "enable_citation": True,         # 开启角标标注功能
                "citation_format": "[ref_<number>]",  # 角标形式
                "search_strategy": "pro"         # 搜索10条互联网信息
            }
        })
```

### 智能联网检测
系统会自动检测以下智能体并启用联网搜索：
- **情感分析师** (`social_media_analyst`) - 搜索社交媒体情绪
- **新闻分析师** (`news_analyst`) - 搜索最新新闻事件
- **基本面分析师** (`fundamentals_analyst`) - 搜索最新财务数据

## 🚀 使用指南

### 1. 安装依赖
```bash
# 运行安装脚本
python install_dashscope.py

# 或手动安装
pip install dashscope
```

### 2. 配置API密钥
```bash
# 方法1: 环境变量
export DASHSCOPE_API_KEY=your_api_key

# 方法2: 在TradingAgents界面中配置
# 提供商: 阿里百炼
# API密钥: your_api_key
```

### 3. 选择支持联网的模型
| 模型名称 | 联网支持 | 推荐用途 |
|----------|----------|----------|
| qwen-turbo | ✅ | 快速分析 |
| qwen-plus | ✅ | 平衡性能 |
| qwen-max | ✅ | 最强性能 |
| **qwen-plus-2025-04-28** | ✅ | **推荐联网模型** |

### 4. 配置智能体
在"🤖 智能体配置"页面中：
```
💭 情感分析师: 阿里百炼:qwen-plus-2025-04-28
📰 新闻分析师: 阿里百炼:qwen-plus-2025-04-28
📊 基本面分析师: 阿里百炼:qwen-plus-2025-04-28
```

## 📊 功能特性

### ✅ 已实现功能
- [x] 完整的DashScope API集成
- [x] 智能联网搜索检测
- [x] 强制搜索模式
- [x] 搜索来源标注
- [x] 引用格式化 `[ref_<number>]`
- [x] 专业搜索策略（10条信息）
- [x] 错误处理和降级
- [x] 通信日志记录

### 🌐 联网搜索示例

#### 情感分析师搜索
```
提示: "请搜索贵州茅台(600519)在今天的社交媒体情绪和投资者情感"

响应: "根据最新搜索结果，贵州茅台今日社交媒体情绪整体偏向谨慎乐观...

📡 搜索来源:
[贵州茅台股吧最新讨论](https://guba.eastmoney.com/list,600519.html)
[雪球茅台话题](https://xueqiu.com/S/SH600519)
[财经新闻评论](https://finance.sina.com.cn/stock/s/sh600519.shtml)
```

#### 新闻分析师搜索
```
提示: "请搜索并分析今天影响股票600519的最新新闻和宏观经济因素"

响应: "基于今日搜索的最新信息，贵州茅台面临以下重要新闻事件[ref_1]...

[ref_1] 茅台集团发布三季度业绩公告
[ref_2] 白酒行业政策调整影响分析
[ref_3] 机构调研报告更新
```

## 🧪 测试验证

### 运行测试脚本
```bash
# 完整功能测试
python test_dashscope_integration.py

# 基础连接测试
python -c "
import asyncio
from app_enhanced import EnhancedTradingAgentsApp
app = EnhancedTradingAgentsApp()
print('阿里百炼' in app.get_common_models_for_provider('阿里百炼'))
"
```

### 测试检查项
- [ ] DashScope包安装成功
- [ ] API密钥配置正确
- [ ] 基础API调用正常
- [ ] 联网搜索功能启用
- [ ] 搜索结果包含来源
- [ ] 智能体集成正常

## ⚠️ 注意事项

### API配额管理
- 联网搜索会消耗更多API配额
- 建议合理配置智能体使用联网功能
- 监控API使用量避免超限

### 模型选择建议
- **生产环境**: 使用 `qwen-plus-2025-04-28`
- **测试环境**: 使用 `qwen-turbo`
- **高质量需求**: 使用 `qwen-max`

### 错误处理
系统会自动处理以下情况：
- API密钥无效 → 返回错误提示
- 网络连接失败 → 自动重试
- 模型不支持联网 → 降级到普通模式
- 搜索结果为空 → 使用LLM内置知识

## 🔗 相关链接

- [阿里百炼官网](https://dashscope.aliyun.com/)
- [DashScope文档](https://help.aliyun.com/zh/dashscope/)
- [API密钥管理](https://dashscope.console.aliyun.com/apiKey)
- [模型价格](https://help.aliyun.com/zh/dashscope/developer-reference/tongyi-thousand-questions-metering-and-billing)

## 📈 性能优化

### 缓存策略
- 相同查询24小时内使用缓存
- 搜索结果本地存储
- 智能去重避免重复搜索

### 并发控制
- 限制同时进行的搜索请求
- 实现请求队列管理
- 避免API频率限制

---

**集成完成时间**: 2025-08-03  
**版本**: v1.0  
**状态**: ✅ 生产就绪
